(()=>{var f={LEFT:["ArrowLeft","a"],RIGHT:["ArrowRight","d"],DOWN:["ArrowDown","s"],ROTATE:["ArrowUp","w"],HARD_DROP:" ",TOGGLE_GHOST:"x",HOLD:"c"};var s={};X();function _(e){return/^Arrow|^Escape$|^Space$|^Enter$|^Tab$/i.test(e)}function X(){try{let e=localStorage.getItem("trixelKeyBindings");if(e){let n=JSON.parse(e);D(n);return}}catch{console.warn("Failed to parse saved keybindings.")}D(f)}function D(e){for(let n in f)if(e[n]){let o=Array.isArray(e[n])?e[n]:[e[n]];s[n]=o.map(a=>_(a)?a:a.toLowerCase())}else{let o=Array.isArray(f[n])?f[n]:[f[n]];s[n]=o.map(a=>_(a)?a:a.toLowerCase())}}function I(e){let n={...s,...e};D(n),localStorage.setItem("trixelKeyBindings",JSON.stringify(n))}function j(e,n){let o=[];for(;n--;)o.push(new Array(e).fill(0));return o}var t={score:0,bestScore:parseInt(localStorage.getItem("bestScore")||0),moveDirection:0,moveTimer:0,moveInterval:50,dasDelay:150,dasTimer:0,moveHeld:!1,downHeld:!1,showPieceBag:!0,downTimer:0,instantSoftDropLock:!1,downInterval:50,lockDelay:1e3,lockTimer:0,isTouchingGround:!1,showGhost:!0,isPaused:!1,pieceBag:[],dropCounter:0,dropInterval:400,lastTime:0,showGridLines:!1,player:{pos:{x:0,y:0},matrix:null},lastPiece:null,arena:j(10,22),heldPiece:null,holdUsed:!1,outlineStyleEnabled:JSON.parse(localStorage.getItem("outlineStyleEnabled"))||!1};function z(e,n){let o=n.matrix,a=n.pos;for(let r=0;r<o.length;++r)for(let i=0;i<o[r].length;++i)if(o[r][i]!==0&&(e[r+a.y]&&e[r+a.y][i+a.x])!==0)return!0;return!1}var Y=["T","J","L","O","S","Z","I"];function V(){(!t.pieceBag||t.pieceBag.length<1)&&ne();let e=t.pieceBag.shift(),n=t.pieceBag[t.pieceBag.length-1]||null,o=F(n);for(;o===e;)o=F(n);return t.pieceBag.push(o),t.lastPiece=e,e}function F(e){let n=Y.filter(o=>o!==e);return n[Math.floor(Math.random()*n.length)]}function ne(){t.pieceBag=oe([...Y])}function oe(e){for(let n=e.length-1;n>0;n--){let o=Math.floor(Math.random()*(n+1));[e[n],e[o]]=[e[o],e[n]]}return e}function Z(e){switch(e){case"T":return[[0,0,0,0],[0,1,1,1],[0,0,1,0],[0,0,0,0]];case"O":return[[0,0,0,0],[0,2,2,0],[0,2,2,0],[0,0,0,0]];case"L":return[[0,0,0,0],[0,3,0,0],[0,3,0,0],[0,3,3,0]];case"J":return[[0,0,0,0],[0,0,4,0],[0,0,4,0],[0,4,4,0]];case"I":return[[0,0,0,0],[5,5,5,5],[0,0,0,0],[0,0,0,0]];case"S":return[[0,0,0,0],[0,0,6,6],[0,6,6,0],[0,0,0,0]];case"Z":return[[0,0,0,0],[0,7,7,0],[0,0,7,7],[0,0,0,0]]}}function W(){!t?.arena||!t?.player||(t.holdUsed=!1,t.player.matrix=Z(V()),t.player.pos.y=0,t.player.pos.x=Math.floor(t.arena[0].length/2)-Math.floor(t.player.matrix[0].length/2),z(t.arena,t.player)&&gameOverReset())}function h(){localStorage.setItem("trixelGameState",JSON.stringify(t)),localStorage.setItem("outlineStyleEnabled",JSON.stringify(t.outlineStyleEnabled))}function R(){let e=JSON.parse(localStorage.getItem("trixelGameState"));if(e&&(t.instantSoftDropLock=e.instantSoftDropLock??t.instantSoftDropLock,t.showPieceBag=e.showPieceBag??t.showPieceBag,t.outlineStyleEnabled=e.outlineStyleEnabled??t.outlineStyleEnabled,t.showGridLines=e.showGridLines??t.showGridLines),!e||!e.player||!e.player.matrix)return W(),!1;let n=e.arena?.some(r=>r.some(i=>i!==0)),o=Array.isArray(e.player.matrix)&&e.player.matrix.length>0,a=n&&o;for(let r=0;r<t.arena.length;r++)for(let i=0;i<t.arena[r].length;i++)t.arena[r][i]=e.arena[r][i];return t.instantSoftDropLock=e.instantSoftDropLock??t.instantSoftDropLock,t.showPieceBag=e.showPieceBag??t.showPieceBag,t.player.pos=e.player?.pos??t.player.pos,t.player.matrix=Array.isArray(e.player?.matrix)?e.player.matrix.map(r=>[...r]):t.player.matrix,t.lastPiece=e.lastPiece??t.lastPiece,t.score=typeof e.score=="number"?e.score:t.score,t.pieceBag=Array.isArray(e.pieceBag)?[...e.pieceBag]:t.pieceBag,t.isTouchingGround=e.isTouchingGround??t.isTouchingGround,t.lockTimer=typeof e.lockTimer=="number"?e.lockTimer:t.lockTimer,t.heldPiece=e.heldPiece??t.heldPiece,re(),a}function re(){let e=document.getElementById("score"),n=document.getElementById("best-score-value");e&&(e.textContent=`${t.score}`),n&&(n.textContent=`${t.bestScore}`)}var k=null;function ae(){document.querySelectorAll("[data-i18n]").forEach(e=>{let n=e.getAttribute("data-i18n"),o=chrome.i18n.getMessage(n);o&&(e.textContent=o)})}document.addEventListener("DOMContentLoaded",ae);function M(e){return/^Arrow|^Escape$|^Space$|^Enter$|^Tab$/i.test(e)?e:e.toLowerCase()}function ie(){let n=JSON.parse(localStorage.getItem("trixelCustomTheme")||"{}").cssVars||{};for(let[o,a]of Object.entries(n))document.documentElement.style.setProperty(`--${o}`,a)}document.addEventListener("DOMContentLoaded",()=>{let e=localStorage.getItem("trixelTheme")||"classic";document.body.classList.add(`theme-${e}`),e==="custom"&&ie();let n=document.getElementById("controls-list"),o=document.getElementById("cancel-edit");function a(d){return d.replace(/_/g," ").toLowerCase().replace(/\b\w/g,l=>l.toUpperCase())}function r(d){return d===" "?"SPACE":d.toUpperCase()}function i(){n.innerHTML="",Object.entries(s).forEach(([c,G])=>{let C=document.createElement("div");C.classList.add("control-row");let $=document.createElement("span"),J=`action_${c.toLowerCase()}`;console.log(J),$.textContent=(chrome.i18n.getMessage(J)||a(c))+":";let O=document.createElement("div");O.classList.add("keys-container"),(Array.isArray(G)?G:[G]).forEach(U=>{let b=document.createElement("span");b.classList.add("key-tag"),b.textContent=r(U);let B=document.createElement("button");B.textContent="\u2716\uFE0F",B.classList.add("remove-key"),B.addEventListener("click",()=>{s[c]=s[c].filter(q=>M(q)!==M(U)),I(s),i()}),b.appendChild(B),O.appendChild(b)});let u=document.createElement("button");u.textContent=chrome.i18n.getMessage("addKey"),u.classList.add("add-key"),u.addEventListener("click",()=>{u.textContent=chrome.i18n.getMessage("pressAKey")+"\u2026",k={action:c,button:u}});let w=document.createElement("div");w.classList.add("action-container"),w.appendChild(O),w.appendChild(u),C.appendChild($),C.appendChild(w),n.appendChild(C)});let d=document.createElement("h3");d.textContent=chrome.i18n.getMessage("settingsHeader"),n.appendChild(d);let l=document.createElement("div");l.classList.add("control-row");let v=document.createElement("span");v.textContent=chrome.i18n.getMessage("instantSoftDrop")+":";let p=document.createElement("input");p.type="checkbox",p.checked=t.instantSoftDropLock,p.addEventListener("change",c=>{t.instantSoftDropLock=c.target.checked,h()});let m=document.createElement("div");m.classList.add("settings-container"),m.appendChild(v),m.appendChild(p),l.appendChild(m),n.appendChild(l);let P=document.createElement("div");P.classList.add("control-row");let K=document.createElement("span");K.textContent=chrome.i18n.getMessage("showPieceBag")+":";let g=document.createElement("input");g.type="checkbox",g.checked=t.showPieceBag,g.addEventListener("change",c=>{t.showPieceBag=c.target.checked,h()});let y=document.createElement("div");y.classList.add("settings-container"),y.appendChild(K),y.appendChild(g),P.appendChild(y),n.appendChild(P);let T=document.createElement("div");T.classList.add("control-row");let N=document.createElement("span");N.textContent=chrome.i18n.getMessage("enableOutlinedStyle")+":";let x=document.createElement("input");x.type="checkbox",x.checked=t.outlineStyleEnabled,x.addEventListener("change",c=>{t.outlineStyleEnabled=c.target.checked,localStorage.setItem("outlineStyleEnabled",JSON.stringify(c.target.checked)),h()});let S=document.createElement("div");S.classList.add("settings-container"),S.appendChild(N),S.appendChild(x),T.appendChild(S),n.appendChild(T);let A=document.createElement("div");A.classList.add("control-row");let H=document.createElement("span");H.textContent=chrome.i18n.getMessage("showGridLines")+":";let E=document.createElement("input");E.type="checkbox",E.checked=t.showGridLines,E.addEventListener("change",c=>{t.showGridLines=c.target.checked,h()});let L=document.createElement("div");L.classList.add("settings-container"),L.appendChild(H),L.appendChild(E),A.appendChild(L),n.appendChild(A)}o.addEventListener("click",()=>{window.location.href="index.html"}),document.addEventListener("keydown",d=>{if(!k)return;let{action:l,button:v}=k,p=M(d.key);Array.isArray(s[l])||(s[l]=[s[l]]);let m=s[l].indexOf(p);m===-1?s[l].push(p):s[l].splice(m,1),I(s),R(),i(),k=null}),R(),i()});})();
