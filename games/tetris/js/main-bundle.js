(()=>{function _(t,o){let r=[];for(;o--;)r.push(new Array(t).fill(0));return r}var S={DROP:1,HARDDROP:3,LANDING:10,LINECLEAR:75},v=[null,"#00faff","#ff0055","#00ff6e","#ffb300","#8e00ff","#ffee00","#ff3030"],L={LEFT:["ArrowLeft","a"],RIGHT:["ArrowRight","d"],DOWN:["ArrowDown","s"],ROTATE:["ArrowUp","w"],HARD_DROP:" ",TOGGLE_GHOST:"x",HOLD:"c"},V=100;var e={score:0,bestScore:parseInt(localStorage.getItem("bestScore")||0),moveDirection:0,moveTimer:0,moveInterval:50,dasDelay:150,dasTimer:0,moveHeld:!1,downHeld:!1,showPieceBag:!0,downTimer:0,instantSoftDropLock:!1,downInterval:50,lockDelay:1e3,lockTimer:0,isTouchingGround:!1,showGhost:!0,isPaused:!1,pieceBag:[],dropCounter:0,dropInterval:400,lastTime:0,showGridLines:!1,player:{pos:{x:0,y:0},matrix:null},lastPiece:null,arena:_(10,22),heldPiece:null,holdUsed:!1,outlineStyleEnabled:JSON.parse(localStorage.getItem("outlineStyleEnabled"))||!1};function y(t,o){let r=o.matrix,n=o.pos;for(let i=0;i<r.length;++i)for(let a=0;a<r[i].length;++a)if(r[i][a]!==0&&(t[i+n.y]&&t[i+n.y][a+n.x])!==0)return!0;return!1}function C(){let t=0;e:for(let o=e.arena.length-1;o>=0;--o){for(let n=0;n<e.arena[o].length;++n)if(e.arena[o][n]===0)continue e;let r=e.arena.splice(o,1)[0].fill(0);e.arena.unshift(r),++o,t++}t>0&&(e.score+=t*S.LINECLEAR)}function k(){e.player.pos.y++;let t=y(e.arena,e.player);return e.player.pos.y--,t}function d(){localStorage.setItem("trixelGameState",JSON.stringify(e)),localStorage.setItem("outlineStyleEnabled",JSON.stringify(e.outlineStyleEnabled))}function j(){let t=JSON.parse(localStorage.getItem("trixelGameState"));if(t&&(e.instantSoftDropLock=t.instantSoftDropLock??e.instantSoftDropLock,e.showPieceBag=t.showPieceBag??e.showPieceBag,e.outlineStyleEnabled=t.outlineStyleEnabled??e.outlineStyleEnabled,e.showGridLines=t.showGridLines??e.showGridLines),!t||!t.player||!t.player.matrix)return h(),!1;let o=t.arena?.some(i=>i.some(a=>a!==0)),r=Array.isArray(t.player.matrix)&&t.player.matrix.length>0,n=o&&r;for(let i=0;i<e.arena.length;i++)for(let a=0;a<e.arena[i].length;a++)e.arena[i][a]=t.arena[i][a];return e.instantSoftDropLock=t.instantSoftDropLock??e.instantSoftDropLock,e.showPieceBag=t.showPieceBag??e.showPieceBag,e.player.pos=t.player?.pos??e.player.pos,e.player.matrix=Array.isArray(t.player?.matrix)?t.player.matrix.map(i=>[...i]):e.player.matrix,e.lastPiece=t.lastPiece??e.lastPiece,e.score=typeof t.score=="number"?t.score:e.score,e.pieceBag=Array.isArray(t.pieceBag)?[...t.pieceBag]:e.pieceBag,e.isTouchingGround=t.isTouchingGround??e.isTouchingGround,e.lockTimer=typeof t.lockTimer=="number"?t.lockTimer:e.lockTimer,e.heldPiece=t.heldPiece??e.heldPiece,B(),n}function O(){e.score>e.bestScore&&(e.bestScore=e.score,localStorage.setItem("bestScore",e.bestScore))}function B(){let t=document.getElementById("score"),o=document.getElementById("best-score-value");t&&(t.textContent=`${e.score}`),o&&(o.textContent=`${e.bestScore}`)}function w(){O(),B(),d()}var Z=["T","J","L","O","S","Z","I"];function Q(){(!e.pieceBag||e.pieceBag.length<1)&&$();let t=e.pieceBag.shift(),o=e.pieceBag[e.pieceBag.length-1]||null,r=X(o);for(;r===t;)r=X(o);return e.pieceBag.push(r),e.lastPiece=t,t}function X(t){let o=Z.filter(r=>r!==t);return o[Math.floor(Math.random()*o.length)]}function $(){e.pieceBag=he([...Z])}function he(t){for(let o=t.length-1;o>0;o--){let r=Math.floor(Math.random()*(o+1));[t[o],t[r]]=[t[r],t[o]]}return t}function G(t){switch(t){case"T":return[[0,0,0,0],[0,1,1,1],[0,0,1,0],[0,0,0,0]];case"O":return[[0,0,0,0],[0,2,2,0],[0,2,2,0],[0,0,0,0]];case"L":return[[0,0,0,0],[0,3,0,0],[0,3,0,0],[0,3,3,0]];case"J":return[[0,0,0,0],[0,0,4,0],[0,0,4,0],[0,4,4,0]];case"I":return[[0,0,0,0],[5,5,5,5],[0,0,0,0],[0,0,0,0]];case"S":return[[0,0,0,0],[0,0,6,6],[0,6,6,0],[0,0,0,0]];case"Z":return[[0,0,0,0],[0,7,7,0],[0,0,7,7],[0,0,0,0]]}}function M(){!e?.player?.pos||!e?.arena||(e.player.pos.y++,y(e.arena,e.player)?(e.player.pos.y--,e.isTouchingGround||(e.isTouchingGround=!0,e.lockTimer=0,e.score+=S.DROP)):e.isTouchingGround?(e.isTouchingGround=!1,e.lockTimer=0):e.score+=S.DROP,e.dropCounter=0)}function H(t){!e?.player?.pos||!e?.arena||(e.player.pos.x+=t,y(e.arena,e.player)&&(e.player.pos.x-=t))}function ee(){if(e.holdUsed)return;let o=e.lastPiece;if(!e.heldPiece)e.heldPiece=o,h();else{let r=e.heldPiece;e.heldPiece=o,e.player.matrix=G(r),e.player.type=r,e.player.pos.y=0,e.player.pos.x=Math.floor(e.arena[0].length/2)-Math.floor(e.player.matrix[0].length/2)}e.holdUsed=!0}function h(){!e?.arena||!e?.player||(e.holdUsed=!1,e.player.matrix=G(Q()),e.player.pos.y=0,e.player.pos.x=Math.floor(e.arena[0].length/2)-Math.floor(e.player.matrix[0].length/2),y(e.arena,e.player)&&gameOverReset())}function ye(t){for(let o=0;o<t.length;++o)for(let r=0;r<o;++r)[t[r][o],t[o][r]]=[t[o][r],t[r][o]];t.forEach(o=>o.reverse())}function te(){if(!e?.player?.matrix||!e?.arena)return;let t=e.player.matrix.map(n=>[...n]),o=e.player.pos.x;ye(e.player.matrix);let r=1;for(;y(e.arena,e.player);)if(e.player.pos.x+=r,r=-(r+(r>0?1:-1)),Math.abs(r)>e.player.matrix[0].length){e.player.matrix=t,e.player.pos.x=o;return}k(e.player)&&!e.isTouchingGround&&(e.isTouchingGround=!0,e.lockTimer=0),d()}function R(t=!0,o=1e3){let r=document.getElementById("controls-overlay");r&&(r.style.display=t?"block":"none",t&&o>0&&setTimeout(()=>{r.style.display="none"},o))}function F(){let t=document.getElementById("pause-menu");t&&(t.style.display="flex")}function z(){let t=document.getElementById("pause-menu");t&&(t.style.display="none")}function oe(){window.location.href="controlsEditor.html"}function N(t,o){let r=!1;o.matrix.forEach((n,i)=>{n.forEach((a,s)=>{if(a!==0){let l=i+o.pos.y;t[l][s+o.pos.x]=a,l<7&&(r=!0)}})}),r&&(q(),O(),B())}function q(){e.arena.forEach(t=>t.fill(0)),e.score=0,e.isTouchingGround=!1,e.lockTimer=0,e.heldPiece=null,w(),h(),$(),R(!0,1e3)}var u={};ge();function re(t){return/^Arrow|^Escape$|^Space$|^Enter$|^Tab$/i.test(t)}function ge(){try{let t=localStorage.getItem("trixelKeyBindings");if(t){let o=JSON.parse(t);ne(o);return}}catch{console.warn("Failed to parse saved keybindings.")}ne(L)}function ne(t){for(let o in L)if(t[o]){let r=Array.isArray(t[o])?t[o]:[t[o]];u[o]=r.map(n=>re(n)?n:n.toLowerCase())}else{let r=Array.isArray(L[o])?L[o]:[L[o]];u[o]=r.map(n=>re(n)?n:n.toLowerCase())}}function g(t,o){let r=o.toLowerCase();return Array.isArray(t)?t.some(n=>n.toLowerCase()===r):t.toLowerCase()===r}function ie(){document.addEventListener("keydown",t=>{if(e.isPaused)return;let o=document.getElementById("controls-overlay");o&&o.style.display!=="none"&&(o.style.display="none");let r=t.key;if(g(u.LEFT,r))H(-1),e.moveDirection=-1,e.moveHeld=!0,e.dasTimer=0,e.moveTimer=0,d();else if(g(u.RIGHT,r))H(1),e.moveDirection=1,e.moveHeld=!0,e.dasTimer=0,e.moveTimer=0,d();else if(g(u.DOWN,r))e.downHeld=!0,e.downTimer=0,M(),w();else if(g(u.ROTATE,r))te(),d();else if(g(u.HARD_DROP,r)){for(;!y(e.arena,e.player);)e.player.pos.y++,e.score+=S.HARDDROP;e.player.pos.y--,N(e.arena,e.player),h(),C(),w()}else g(u.TOGGLE_GHOST,r)?e.showGhost=!e.showGhost:g(u.HOLD,r)&&(ee(),d())}),document.addEventListener("keyup",t=>{let o=t.key;(g(u.LEFT,o)||g(u.RIGHT,o))&&(e.moveHeld=!1,e.moveDirection=0,e.dasTimer=0,e.moveTimer=0),g(u.DOWN,o)&&(e.downHeld=!1,e.downTimer=0)})}var K=document.getElementById("trixel"),c=K.getContext("2d");c.scale(30,30);function we(t,o,r,n,i=c){i.shadowBlur=n,i.shadowColor=r;var a,s;if(e.spacedStyleEnabled?(a=1/16,s=1-a*2):(a=0,s=1),i.fillStyle=r,i.fillRect(t+a,o+a,s,s),i.shadowBlur=0,e.outlineStyleEnabled){let l=le(r,.05),f=.05;i.strokeStyle=l,i.lineWidth=f,i.strokeRect(t+f,o+f,1-f,1-f)}}function le(t,o=.2){let r=document.createElement("div");r.style.color=t,document.body.appendChild(r);let n=getComputedStyle(r).color;document.body.removeChild(r);let i=n.match(/\d+/g);if(!i)return t;let[a,s,l]=i.map(Number);return a=Math.min(255,a+255*o),s=Math.min(255,s+255*o),l=Math.min(255,l+255*o),`rgb(${a}, ${s}, ${l})`}function Te(t,o=""){return getComputedStyle(document.body).getPropertyValue(t).trim()||o}function I(t,o,r=c,n={hideHiddenRows:!0}){let i=Te("--cell-glow","pulse"),a=0;i==="pulse"?a=6+Math.sin(Date.now()/300)*2:isNaN(parseFloat(i))||(a=parseFloat(i));let s=.07,l=[[0,-1],[1,0],[0,1],[-1,0]];t.forEach((f,T)=>{let m=n.hideHiddenRows?T+o.y-4:T+o.y;n.hideHiddenRows&&m<0||f.forEach((P,b)=>{if(P===0)return;let p=b+o.x,Y=v[P];we(p,m,Y,a,r),r.strokeStyle=le(Y,.1),r.lineWidth=s,l.forEach(([D,A])=>{let J=b+D,U=T+A;(U<0||U>=t.length||J<0||J>=t[0].length?0:t[U][J])===0&&(r.beginPath(),D===0&&A===-1?(r.moveTo(p,m),r.lineTo(p+1,m)):D===1&&A===0?(r.moveTo(p+1,m),r.lineTo(p+1,m+1)):D===0&&A===1?(r.moveTo(p+1,m+1),r.lineTo(p,m+1)):D===-1&&A===0&&(r.moveTo(p,m+1),r.lineTo(p,m)),r.lineJoin="miter",r.stroke())})})})}CanvasRenderingContext2D.prototype.roundRect=function(t,o,r,n,i){this.moveTo(t+i,o),this.lineTo(t+r-i,o),this.quadraticCurveTo(t+r,o,t+r,o+i),this.lineTo(t+r,o+n-i),this.quadraticCurveTo(t+r,o+n,t+r-i,o+n),this.lineTo(t+i,o+n),this.quadraticCurveTo(t,o+n,t,o+n-i),this.lineTo(t,o+i),this.quadraticCurveTo(t,o,t+i,o)};function ce(t,o,r){let n={x:o.x,y:o.y};for(;!y(r,{pos:n,matrix:t});)n.y++;return n.y--,n}function Se(){let t=ce(e.player.matrix,e.player.pos,e.arena),o=[];return e.player.matrix.forEach((r,n)=>{r.forEach((i,a)=>{i!==0&&o.push([a+t.x,n+t.y])})}),o}function ve(){let t=ce(e.player.matrix,e.player.pos,e.arena);c.globalAlpha=.3,I(e.player.matrix,t),c.globalAlpha=1}function xe(){c.strokeStyle="#ee1222",c.lineWidth=.1,c.beginPath(),c.moveTo(0,3),c.lineTo(10,3),c.stroke()}function Ee(){let{isTouchingGround:t,lockTimer:o,lockDelay:r,player:n}=e;if(t){let i=Math.min(o/r,1),a=Math.sin(i*Math.PI),s=.25,f=s+(1-s)*a;c.globalAlpha=f,I(n.matrix,n.pos),c.globalAlpha=1}else I(n.matrix,n.pos)}function Pe(){if(!e.showGridLines)return;let t=e.arena,o=t[0].length,r=t.length,n=Se();c.strokeStyle="rgba(51, 51, 51, 0.7)",c.lineWidth=.02;for(let i=4;i<r;i++)for(let a=0;a<o;a++){let s=n.some(([l,f])=>l===a&&f===i);t[i][a]===0&&!s&&c.strokeRect(a,i-4,1,1)}}function fe(){c.fillStyle=getComputedStyle(document.body).getPropertyValue("--bg-color").trim(),c.fillRect(0,0,K.width,K.height),I(e.arena,{x:0,y:0}),Pe(),e.showGhost&&ve(),Ee(),xe()}function ae(t){let o=0,r=t[0].length-1;for(;o<=r&&t.every(n=>n[o]===0);)o++;for(;r>=o&&t.every(n=>n[r]===0);)r--;return t.map(n=>n.slice(o,r+1))}function me(){let t=document.getElementById("piece-bag");if(document.documentElement.style.setProperty("--total-width",e.showPieceBag?"380px":"300px"),e.showPieceBag)t.style.display="flex";else{t.style.display="none";return}t.innerHTML="";let o=16,r=64;e.pieceBag.slice(0,5).forEach(i=>{let a=se(G(i));a=ae(a);let s=document.createElement("canvas");s.className="piece-preview",s.width=r,s.height=r;let l=s.getContext("2d");l.scale(o,o);let f=a[0].length,T=a.length,m=r/o-f,P=r/o-T,b=m/2,p=P/2;I(a,{x:b,y:p},l,{hideHiddenRows:!1}),t.appendChild(s)});let n=document.createElement("div");if(n.style.height="2px",n.style.width="80%",n.style.margin="4px auto",n.style.background="rgba(255,255,255,0.2)",n.style.borderRadius="1px",t.appendChild(n),e.heldPiece){let i=document.createElement("div");i.textContent=chrome.i18n.getMessage("holdLabel"),i.style.textAlign="center",i.style.fontSize="12px",i.style.color="var(--secondary-text-color)",t.appendChild(i);let a=document.createElement("canvas");a.className="piece-preview",a.width=r,a.height=r;let s=a.getContext("2d");s.scale(o,o);let l=se(G(e.heldPiece));l=ae(l);let f=l[0].length,T=l.length,m=r/o-f,P=r/o-T,b=m/2,p=P/2;I(l,{x:b,y:p},s,{hideHiddenRows:!1}),a.style.opacity=.9,t.appendChild(a)}}function se(t){for(;t.length&&t[0].every(n=>n===0);)t.shift();for(;t.length&&t[t.length-1].every(n=>n===0);)t.pop();let o=0,r=t[0].length-1;for(;o<=r&&t.every(n=>n[o]===0);)o++;for(;r>=o&&t.every(n=>n[r]===0);)r--;return t.map(n=>n.slice(o,r+1))}function be(t){e.downTimer+=t,e.isTouchingGround&&k(e.arena,e.player)&&e.lockTimer>V?e.instantSoftDropLock&&(N(e.arena,e.player),h(),C(),w(),e.isTouchingGround=!1,e.lockTimer=0,e.downTimer=0):e.downTimer>e.downInterval&&(M(),e.downTimer=0,w())}function Le(t){e.dropCounter+=t,e.dropCounter>e.dropInterval&&(M(),d())}function ke(t){let o=k(e.arena,e.player);o&&!e.isTouchingGround?(e.isTouchingGround=!0,e.lockTimer=0):!o&&e.isTouchingGround&&(e.isTouchingGround=!1,e.lockTimer=0),e.isTouchingGround&&(e.lockTimer+=t,e.lockTimer>e.lockDelay&&k(e.arena,e.player)&&(N(e.arena,e.player),h(),C(),w(),e.isTouchingGround=!1,e.lockTimer=0))}function E(t=0){if(e.isPaused){requestAnimationFrame(E);return}let o=t-e.lastTime;e.lastTime=t,Le(o),ke(o),e.moveHeld&&(e.dasTimer+=o,e.moveTimer+=o,e.dasTimer>e.dasDelay&&e.moveTimer>e.moveInterval&&(H(e.moveDirection),e.moveTimer=0),d()),e.downHeld&&be(o),fe(),me(),requestAnimationFrame(E)}function pe(){document.getElementById("restart").addEventListener("click",()=>{e.isPaused||(q(),localStorage.removeItem("trixelGameState"),e.isTouchingGround=!1,e.lockTimer=0,h(),R(!0,1e3))}),document.getElementById("pause").addEventListener("click",()=>{e.isPaused=!e.isPaused;let t=document.getElementById("pause");e.isPaused?(t.textContent="\u25B6",t.classList.add("small"),F()):(t.textContent="\u23F8",t.classList.remove("small"),z(),e.lastTime=performance.now(),e.dropCounter=0,e.downTimer=0,E()),e.isPaused?F():(z(),e.lastTime=performance.now(),e.dropCounter=0,e.downTimer=0,E())}),document.querySelectorAll("button").forEach(t=>{t.setAttribute("tabindex","-1"),t.addEventListener("keydown",o=>o.preventDefault()),t.addEventListener("mousedown",o=>o.preventDefault())}),document.getElementById("btn-edit-controls").addEventListener("click",()=>{oe()}),document.getElementById("btn-edit-theme").addEventListener("click",()=>{window.location.href="themeEditor.html"})}function W(t){let o=document.body;if(typeof t=="string"){localStorage.setItem("trixelTheme",t),o.classList.remove("theme-eclipse","theme-wave","theme-rose","theme-classic","theme-custom"),o.classList.add(`theme-${t}`);let r={rose:["#ffa6fc","#ff94e0","#ff76d8","#ff59c7","#f000b8","#db008b","#b10065"],classic:["#f438ff","#ffe038","#fe8d0f","#3877ff","#0dc2ff","#00f867","#ff002b"],wave:["#1a74e2","#2b8cf0","#3fa0ef","#55b9fb","#6bd0ff","#46a9ff","#148aff"],eclipse:["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],heat:["#d82935","#ff5a3d","#ff7847","#ff944c","#ffb347","#ffd100","#ffe34d"]};v.splice(0,v.length,null,...r[t])}else if(typeof t=="object"){let{cssVars:r,pieceColors:n}=t;localStorage.setItem("trixelTheme","custom"),localStorage.setItem("trixelCustomTheme",JSON.stringify(t)),Object.entries(r).forEach(([i,a])=>{document.documentElement.style.setProperty(`--${i}`,a)}),v.splice(0,v.length,null,...n),o.className="theme-custom";return}}function de(){let t=["classic","eclipse","wave","heat","rose","custom"],o=localStorage.getItem("trixelTheme")||"classic";if(o==="custom"){let r=localStorage.getItem("trixelCustomTheme");try{let n=JSON.parse(r);W(n)}catch{console.warn("Invalid custom theme; falling back to classic"),W("classic")}}else t.includes(o)?W(o):(console.warn(`Theme '${o}' not found. Falling back to classic.`),W("classic"))}function Be(){document.querySelectorAll("[data-i18n]").forEach(t=>{let o=t.getAttribute("data-i18n"),r=chrome.i18n.getMessage(o);r&&(t.textContent=r)})}document.addEventListener("DOMContentLoaded",Be);de();var Ge=j();E();O();B();Ge||R(!0,1e3);pe();ie();window.addEventListener("beforeunload",()=>{d()});})();
